---
title: "White Wine Quality"
author: "Siyu Bao"
date: "10/11/2016"
output: html_document
---
<br>
This report explores a dataset containing chemical information and the quality score of different labels of white wine.
<br>
<br>

###Dataset Summary
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
library(ggplot2)
library(reshape2)
library(gridExtra)
library(lattice)
library(grid)
library(GGally)
library(dplyr)
library(memisc)
whiteWine <- read.csv('wineQualityWhites.csv')
str(whiteWine)
```
The dataset consists of 13 variables, with 4898 observations.
<br><br>

### Univariate Plots Selection
<br>

####Distribution of Quality Scores
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
qplot(x = quality, data = whiteWine, geom = c("histogram"), binwidth = 0.4,
      fill = I("#B0C4DE")) + 
  scale_x_continuous(breaks = seq(3, 9, 1)) +
  geom_vline(xintercept = mean(whiteWine$quality), color = "red", linetype = 2) +
  geom_vline(xintercept = median(whiteWine$quality), color = "blue", linetype = 2)
```

The quality scores of wines seem to be normally distributed. There are very few wines being rated as 3 (very poor quality) and 9 (excellent quality). The mean(red line), median(blue line), and mode of quality ratings all fall nearby the score of 6. Based on the information given in the dataset, I wonder which factors can effectively represent the quality score of white wine.
<br><br>

####Distribution of Independent Variables 
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
whiteWine$quality <- factor(whiteWine$quality, ordered = TRUE)
melted_data = melt(whiteWine[c(2:13)], id.vars = "quality")
ggplot(aes(value), data = melted_data) +
  geom_histogram(bins = 60) +
  facet_wrap(~variable, scales = "free")
```

We can see that most of the independent variables are normally distributed, except for residual sugar. We'll perform log transformation to get a better representation of the distribution. Another interesting factor to consider is the two SO2 content variables. We can analyze the proportion of free SO2 in later analysis.

```{r}
whiteWine$prop_free.sulfur.dioxide <- whiteWine$free.sulfur.dioxide / whiteWine$total.sulfur.dioxide
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
q1 <- qplot(x = fixed.acidity, data = whiteWine, bins = 100) +
  coord_cartesian(xlim = c(3.7, 12))
q2 <- qplot(x = volatile.acidity, data = whiteWine, bins = 100)
q3 <- qplot(x = citric.acid, data = whiteWine, bins = 100) +
  coord_cartesian(xlim = c(0, 1.3))
q4 <- qplot(x = residual.sugar, data = whiteWine, bins = 100, xlim = c(0, 33)) + scale_x_log10(breaks = c(1, 1.2, 1.6, 3, 8, 20))
q5 <- qplot(x = chlorides, data = whiteWine, bins = 100)
q6 <- qplot(x = free.sulfur.dioxide, data = whiteWine, binwidth = 1) +
  coord_cartesian(xlim = c(0, 150))
q7 <- qplot(x = total.sulfur.dioxide, data = whiteWine, binwidth = 4) +
  coord_cartesian(xlim = c(0, 370))
q8 <- qplot(x = sulphates, data = whiteWine, binwidth = 0.01)
q9 <- qplot(x = density, data = whiteWine, bins = 100) +
  scale_x_continuous(limits = c(0.987, 1.004))
q10 <- qplot(x = pH, data = whiteWine, bins = 100)
q11 <- qplot(x = alcohol, data = whiteWine, binwidth = 0.1)
q12 <- qplot(x = prop_free.sulfur.dioxide, data = whiteWine, binwidth = 0.01)
grid.arrange(q1, q2, q3, q4, q5, q6, q7, q8, q9, q10, q11, q12, top = "Adjusted Distribution Plots", ncol = 4)
```

The log transformed residual.sugar distribution appears bi-modal with the peaks at around 1.1-1.6 and 8.0 g/dm^3 or so. <br>
Chloride levels don't seem to differ much across the wines in the dataset.<br>
Proportions of free sulfur dioxide is distributed normally with a peak at around 25% - 28% or so. 

###Univariate Analysis
<br>

####1. What is the structure of the dataset?
There are 4,898 different labels of white wine with 12 features (fixed acidity, volatile acidity, citric acid, residual sugar, chlorides, free sulfur dioxide, total sulfur dioxide, density, pH, sulphates, alcohol, and quality). All the variables are continuous.<br>
The quality rating is on a scale of 0 (very bad) to 10 (very good). Wines in the current dataset only covers ratings of 3-9. <br> 

Other observations: <br>
* Most white wine in the dataset have very little residual sugar content (around 1g per cubic decimeter).<br>
* Most wines contain similar amounts of salt (sodium chloride), which peaks at .03-.06g per cubic decimeter.<br><br>

####2. What is/are the main features of interest of the dataset?
The main feature of interest is the quality ratings. We look to investigate which chemicals influence the quality rating of white wines.<br><br>

####3. What other features in the dataset do you think will help support your investigation into your features of interest?
Both residual.sugar and alcohol levels have interesting distributions. There may also be interrelationships between some of the variables. 
<br><br>

####4. Did you create any new variables from existing data?
Yes, I took the percentage of free.SO2 level according to total.SO2 level to calculate the proportion of free sulfur dioxide content.<br><br>

####5. Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?
As the quality ratings are only integers from 3-9, I changed it into an ordered factor. <br>
Residual sugar was distributed with a long tail thus a log transformation was performed. <br>
There may be outliers in the dataset, but I kept them for further studies of the best and worst wines.
<br><br>

###Bivariate Plots Selection
<br>

```{r, echo=FALSE, fig.height=9, fig.width=13.6, message=FALSE, warning=FALSE, results='hold'}
ggpairs(whiteWine, columns = c(2:6,9:14),
        title = "Scatter Plot Matrix of Selected Variables",
        lower = list(continuous = wrap("points", shape  = I('.'))), 
        upper = list(combo = wrap("box", outlier.shape = I('.')),
                     discrete = "facetbar"),
        diag = list(continuous = "densityDiag", discrete = "barDiag"),
        axisLabels = "show")
```

The four highest correlation coefficients of variables with quality:
quality~alcohol

```{r, echo=TRUE, message=FALSE, warning=FALSE}
cor(as.numeric(whiteWine$quality), whiteWine$alcohol)
```

quality~chlorides

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
cor(as.numeric(whiteWine$quality), whiteWine$chlorides)
```

quality~density

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
cor(as.numeric(whiteWine$quality), whiteWine$density)
```

quality~prop_free.sulfur.dioxide
 
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
cor(as.numeric(whiteWine$quality), whiteWine$prop_free.sulfur.dioxide)
```

Some observations:<br>
* Correlation coefficients for quality and other variables are not displayed. However, boxplots of quality ~ alcohol and quality ~ density show interesting patterns that worth further investigation.<br>
* As the selected correlation coefficients have shown, quality of wine cannot be sufficiently predicted by any chemical content alone.<br>
* Density and residual sugar seem to be positively correlated (r = 0.839).<br>
* Chlorides and alcohol are slightly negatively correlated (r = -0.36). <br>
* Density and alcohol are also moderately correlated (r = -0.78).<br>
We'll take a further look into these variables.<br><br>

####Scatterplot of Quality And Selected Variables
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
p1 <- ggplot(aes(x = alcohol, y = quality), data = whiteWine) +
  geom_jitter(alpha = 0.5, color = I("#B0C4DE"))
p2 <- ggplot(aes(x = chlorides, y = quality), data = whiteWine) +
  geom_jitter(alpha = 0.5, color = I("#B0C4DE")) +
  scale_x_continuous(limits = c(0, 0.25))
p3 <- ggplot(aes(x = density, y = quality), data = whiteWine) +
  geom_jitter(alpha = 0.5, color = I("#B0C4DE")) +
  xlim(c(0.985, 1.005))
p4 <- ggplot(aes(x = prop_free.sulfur.dioxide, y = quality), data = whiteWine) + geom_jitter(alpha = 0.5, color = I("#B0C4DE")) +
  scale_x_continuous(limits = c(0, 0.7))
grid.arrange(p1,p2,p3,p4, ncol = 2)
```

From the plots above we can see patterns of slight correlations between quality and alcohol, chlorides, density, and free SO2 proportion. <br>
More specifically, the quality rating increases as alcohol content increases. The same pattern applies to free SO2 proportion levels. <br>
In contrast, the higher density level a wine has, the its quality rating it may get. <br>
In terms of chlorides, there is no obvious pattern due to too many extreme values.<br><br>

####Alcohol Content
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = alcohol, fill = quality), data = whiteWine) +
  geom_histogram(bins = 40) +
  scale_fill_brewer("Set1")
```

We can see from the stacked histogram above that low-quality wines gather at the left side of the graph while the higher quality ones on the right side. <br>
The relationship is not easy to see as there are too many levels of quality. Next we'll regroup ratings into three buckets for a better color visualization.
<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE}
whiteWine$quality.int <- as.integer(as.character(whiteWine$quality))
whiteWine$quality.bucket <- cut((whiteWine$quality.int), c(2, 5, 7, 10), ordered = TRUE)
table(whiteWine$quality.bucket)

ggplot(aes(x = alcohol, fill = quality.bucket, color = quality.bucket), data = whiteWine) +
  geom_density(alpha = 0.4)
```

Conditional means/medians of alcohol content among three quality groups:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
quality_groups <- group_by(whiteWine, quality.bucket)
alcohol_by_quality <- summarise(quality_groups, alcohol_mean = mean(alcohol), alcohol_median = median(alcohol), n = n())
arrange(alcohol_by_quality, quality.bucket)
```

It's clearly shown that high quality wines tend to have higher alcohol content and poorer quality wines to have lower alcohol content.<br><br>

####Chlorides (Eliminated top 2% chloride levels)
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = chlorides, fill = quality.bucket, color = quality.bucket), data = subset(whiteWine, chlorides < quantile(chlorides, probs = 0.98))) +
  geom_density(alpha = 0.4)
```

After adjusting for the long tail, the difference among the three quality groups is still not very clear to see. Although the difference in chloride level is minimal, we can see that higher content of chlorides tend to exist among lower quality wines. 

####Density (Eliminated top 0.5% density levels)
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = density, fill = quality.bucket, color = quality.bucket), 
       data = subset(whiteWine, density < quantile(density, probs = 0.995))) + geom_density(alpha = 0.4)
```

Conditional means/medians of density among three quality groups:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
density_by_quality <- summarise(quality_groups, density_mean = mean(density), density_median = median(density), n = n())
arrange(density_by_quality, quality.bucket)
```

Although the conditional mean/median comparison indicates that the difference among the groups is minimal, the density plot shows that within a small range of density levels, poorer quality wines tend to have higher density level and better quality wines tend to have lower.

####Free SO2 Proportion
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = prop_free.sulfur.dioxide, fill = quality.bucket, color = quality.bucket), data = whiteWine) +
  geom_density(alpha = 0.4)
```

Conditional means/medians comparison among three quality groups:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
SO2_by_quality <- summarise(quality_groups, SO2_mean = mean(prop_free.sulfur.dioxide), SO2_median = median(prop_free.sulfur.dioxide), n = n())
arrange(SO2_by_quality, quality.bucket)
```

The density plot suggests that free SO2 proportion levels do not differ very much across the three quality buckets. The correlations we found from the scatterplot matrix may have been the result of covariance. We'll plot some of these variables together to further see their interrelationships. 

###Bivariate Analysis
<br>

####1. Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

Quality correlates strongly with alcohol content. <br>
The variance in alcohol levels peaks among the lower and the higher quality wines. High-quality wines tend to have higher alcohol content (11-13%) and low-quality wines tend to have lower alcohol content (8.5-10%). Medium-quality wines typically spread out nicely across alcohol content around 9-13%. <br><br>

Density level also seems to have a high influence on the quality ratings of wine. The interactions between some of these factors may be important to look further into when we try to predict the quality ratings of wines. <br><br>

####2. Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

It seems that the density level of wine is correlated with many other features. It is highly correlated with residual sugar - an increase in residual sugar content increases density levels. Density is also moderately correlated with alcohol content, a decrease in alcohol level will increase the density of wines. <br><br>
Other interesting correlations are found between chlorides and alcohol, and residual sugar and alcohol. The correlation coefficient is around 0.35-0.4, but it's hard to see the relation from the scatter plots. We'll plot them together to see further interactions. <br><br> 

####3. What was the strongest relationship you found?

The strongest correlation was between quality rating and alcohol levels. The correlation is even stronger when we put wines of different quality buckets.<br>
As we've found other variables that could potentially share covariance with alcohol levels, we'll investigate further on chlorides, residual sugar, and density levels. 
<br><br>

### Multivariate Plots Selection
<br>

####Density and Residual sugar, colored by quality buckets

Density and residual sugar have a strong correlation of 0.839.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = density, y = residual.sugar), data = whiteWine) +
  geom_jitter(aes(color = quality.bucket), alpha = 0.3) +
  scale_x_continuous(limits = c(0.985, 1.005)) +
  scale_y_continuous(limits = c(0, 30)) +
  geom_smooth(aes(color = quality.bucket), se = FALSE)
```

After adjusting the scales and eliminating the outlier, we can see almost three distinct upward lines for the different quality buckets. This plot suggests that density level increases when residual sugar content increases. Poor quality wines tend to have a higher density level. Median and high quality wines, on the other hand, tend to have lower density levels. <br><br>

####Density and alcohol, colored by quality buckets

Density and residual sugar have a strong correlation of -0.78.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = density, y = alcohol), data = whiteWine) +
  geom_jitter(aes(color = quality.bucket), alpha = 0.3) +
  scale_x_continuous(limits = c(0.986, 1.005)) +
  geom_smooth(aes(color = quality.bucket), se = FALSE)
```

From the scatterplot above we can see that higher alcohol content is associated with lower density levels. Median and high quality wines tend to have higher alcohol content and lower density levels, while lower quality wines tend to have high density and lower alcohol content.<br><br>

####Alcohol and Chlorides, colored by quality

Alcohol and Chlorides have a moderate correlation of -0.36.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = chlorides, y = alcohol), data = whiteWine) +
  geom_jitter(aes(color = quality.bucket), alpha = 0.3) +
  geom_smooth(aes(color = quality.bucket), se = FALSE)
```

It seems like other than difference in alcohol content, some of the low quality wines tend to have higher chloride rate. However, the difference in chlorides seem to be minimal.

####Alcohol and Residual Sugar, colored by quality

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = residual.sugar, y = alcohol), data = whiteWine) +
  geom_jitter(aes(color = quality.bucket), alpha = 0.3) +
  scale_x_continuous(limits = c(0, 32)) +
  geom_smooth(aes(color = quality.bucket), se = FALSE)
```

Apart from the correlation between alcohol and quality buckets, the difference in residual sugar seem to be minimal.

####Modeling Wine Quality Ratings
 
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
m1 <- lm(quality.int ~ alcohol, data = whiteWine)
m2 <- update(m1, ~. + density)
m3 <- update(m2, ~. + residual.sugar)
m4 <- update(m3, ~. + chlorides)
m5 <- update(m4, ~. + prop_free.sulfur.dioxide)
mtable(m1, m2, m3, m4, m5, sdigits = 3)
summary(m5)
```

Among the models above, model 5 captured the most variance (adj. R^2 = 0.232) in the dataset and has the lowest BIC among all. We'll take a look at the distribution of residuals of model 5.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
res <- residuals(m5)
qplot(x = res, y = ..count.., data = whiteWine, geom = "freqpoly", color = quality, binwidth = 0.2, xlab = "Residuals", main = "Distribution of Residuals") +
  scale_x_continuous(breaks = seq(-4, 4, 1))
```

We can see that the majority of residuals occurred in the 5 and 6 category, the errors of which are mostly within -1 and 1. An error of 1 in this case is pretty understandable. We can say that the model does a decent job of predicting the quality score of wines. 

###Multivariate Analysis
<br>

####Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

Alcohol concentration seems to be the deciding factor for evaluating wine quality. Although other features also seem to influence the wine, their influence on wine quality is rather indirect, as they correlate more strongly with alcohol level instead of with quality ratings directly. <br><br>

####Were there any interesting or surprising interactions between features?

It's interesting to see that the density of wine decreases as the alcohol content increases. More surprisingly, we found that the level of residual sugar also decreases as the alcohol increases. It would be fascinating to learn more about the chemical/biological reaction taking place during wine productions.<br><br>

####OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

Yes, I created a linear model starting from alcohol content and density level.<br>
The variables in the linear model only accounted for 23.2% of the variance in the quality of wines. The addition of residual sugar, chloride, and free SO2 proportion slightly improved the R^2 value by 4%, which is expected base on the visualizations of correlations found between features. Also, as taking  log10 of residual sugar does not improve the goodness of fit, the feature was included in the model in its original form. <br><br>


###Final Plots and Summary
<br>

####Plot One

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = alcohol, fill = quality.bucket, color = quality.bucket), data = whiteWine) +
  geom_density(alpha = 0.4) +
  scale_x_continuous(limits = c(8, 14)) +
  labs(x = "Alcohol (% by Volume)", title = "Density of Alcohol Concentraiton by Quality")
```

####Discription One

There is a strong correlation between quality rating and alcohol levels. High quality wines tend to have higher alcohol content and poorer quality wines tend to have lower alcohol concentration. <br><br>

####Plot Two

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
ggplot(aes(x = density, y = alcohol), data = whiteWine) +
  geom_jitter(aes(color = quality.bucket), alpha = 0.3) +
  scale_x_continuous(limits = c(0.986, 1.005)) +
  geom_smooth(aes(color = quality.bucket), se = FALSE) +
  labs(x = "Density of Wine (g/cm^3)", y = "Alcohol (% by Volume)",
       title = "Density Vs. Alcohol by Quality")
```

####Discription Two

From the plot we can see that alcohol and density of wine are negatively correlated. Median and high quality wines tend to have higher alcohol content and lower density levels, while lower quality wines tend to have high density and lower alcohol content.<br><br>

####Plot Three

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hold'}
qplot(x = res, y = ..count.., data = whiteWine, geom = "freqpoly", color = quality, binwidth = 0.2, xlab = "Residuals", main = "Distribution of Residuals") +
  scale_x_continuous(breaks = seq(-4, 4, 1))
```

####Discription Three

After we chose to fit the model: quality = 56.57 + 0.26(alcohol) - 54.29(density) + 0.04(residual.sugar) - 1.86(chlorides) + 1.40(free.SO2 / total.SO2), the residuals are plotted as above. As we can see the majority of error comes in ratings of 5 and 6 within the range of -1 and 1, we can say that the model does a decent job describing the current dataset.<br><br>

###Reflection
<br>

The white wine dataset contains information about 5,000 labels of wine. I started by understanding the individual variables, then I explored the correlations between each pairs of features and had some interesting observations. <br>

There was a trend between the alcohol concentration of wine and its quality. The trend is clearer when I regrouped the wines into three buckets by their quality score. Having quality rating with three levels made it easier to visualize the correlation with other features of wine. <br>

With all the information I've found, I was able to create a linear model capturing the dynamic between different features of wines to predict white wine qualities. Although it only captures 23% of the variations in the dataset, the error is within an acceptable range. However, as the model only took linear variables into account, further adjustments and improvements can be made by exploring other possibilities.<br><br>

###References
* P. Cortez, A. Cerdeira, F. Almeida, T. Matos and J. Reis. 
  Modeling wine preferences by data mining from physicochemical properties.
  In Decision Support Systems, Elsevier, 47(4):547-553. ISSN: 0167-9236.
